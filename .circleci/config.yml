version: 2

references:

  cache_key: &cache_key
    key: jars-{{ checksum "build.gradle" }}-{{ checksum  "app/build.gradle" }}
  restore_cache: &restore_cache
      restore_cache:
        <<: *cache_key
  save_cache: &save_cache
      save_cache:
        <<: *cache_key
        paths:
          - ~/.gradle
          - ~/.m2
  workspace: &workspace
    ~/workspace
  attach_debug_workspace: &attach_debug_workspace
    attach_workspace:
      at: *workspace
  attach_release_workspace: &attach_release_workspace
    attach_workspace:
      at: *workspace
  persist_debug_workspace: &persist_debug_workspace
    persist_to_workspace:
      root: *workspace
      paths:
        - app/build/outputs/androidTest-results
        - app/build/outputs/apk
        - app/build/outputs/code-coverage
        - app/build/test-results
  persist_release_workspace: &persist_release_workspace
    persist_to_workspace:
      root: *workspace
      paths:
        - app/build
  attach_firebase_workspace: &attach_firebase_workspace
    attach_workspace:
      at: *workspace
  persist_firebase_workspace: &persist_firebase_workspace
    persist_to_workspace:
      root: *workspace
      paths:
        - firebase
## Docker image configurations

  android_config: &android_config
    working_directory: *workspace
    docker:
      - image: circleci/android:api-27-alpha
    environment:
        TERM: dumb
        GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m"'

  swap_tt_key: &swap_tt_key
    run:
      name: Swap TomTom Key
      command: sed -i "s/TTKEY/$SECRET/g" app/src/main/AndroidManifest.xml
  encrypt_keystore: &encrypt_keystore
      run:
        name: Encrypt keystore
        command: openssl aes-256-cbc -d -in saramak.jks.enc -out saramak.jks -k $SECRET -md md5

jobs:

  ## Build debug APK and instrumented test APK

  build_release:
      <<: *android_config
      steps:
        - checkout
        - *restore_cache
        - *swap_tt_key
        - *encrypt_keystore
        - run:
            name: Download dependencies
            command: ./gradlew androidDependencies
        - *save_cache
        - run:
              name: Run Tests
                  command: ./gradlew lint build
        - *persist_debug_workspace
        - store_artifacts:
            path: app/build/reports
            destination: reports
        - store_artifacts:
            path: app/build/outputs/apk/
            destination: apk
        - store_test_results:
            path: app/build/test-results


workflows:
  version: 2
  workflow:
    jobs:
      - build_release

